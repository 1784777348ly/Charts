//
//  KTXRender.swift
//  DGCharts
//
//  Created by liuyang on 2025/11/10.
//

import Foundation

@objc public class KTBGX1TOX2Render: LineChartRenderer {
    
    private var backgroundRegions: [(startX: Double, endX: Double, color: UIColor)] = []
    
    @objc public func addBackgroundRegion(from startX: Double, to endX: Double, with color: UIColor) {
        backgroundRegions.append((startX, endX, color))
    }
    
    public override func drawExtras(context: CGContext) {
        super.drawExtras(context: context)
        drawBackgroundRegions(context: context)
    }
    
    private func drawBackgroundRegions(context: CGContext) {
        guard !backgroundRegions.isEmpty else { return }
        
        context.saveGState()
        
        for region in backgroundRegions {
            drawBackgroundRegion(context: context, from: region.startX, to: region.endX, with: region.color)
        }
        
        context.restoreGState()
    }
    
    private func drawBackgroundRegion(context: CGContext, from startX: Double, to endX: Double, with color: UIColor) {
            guard let dataProvider = dataProvider else { return }
            
            let contentRect = viewPortHandler.contentRect
            let transformer = dataProvider.getTransformer(forAxis: .left)
            
            let yMin = dataProvider.chartYMin
            let yMax = dataProvider.chartYMax
            
            // 转换起点坐标
            let startPoint = transformer.pixelForValues(x: startX, y: yMax)
            let endPoint = transformer.pixelForValues(x: endX, y: yMin)
            
            // 创建背景区域路径
            let backgroundRect = CGRect(
                x: startPoint.x,
                y: contentRect.origin.y,
                width: endPoint.x - startPoint.x,
                height: contentRect.size.height
            )
            
            // 设置填充颜色
            context.setFillColor(color.cgColor)
            
            // 绘制背景区域
            context.fill(backgroundRect)
        }
    }

